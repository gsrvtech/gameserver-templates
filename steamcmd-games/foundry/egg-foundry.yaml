_comment: 'DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY PANEL'
meta:
  version: PLCN_v2
  update_url: 'https://raw.githubusercontent.com/gsrvtech/gameserver-templates/main/steamcmd-games/foundry/pelican-egg-foundry.json'
exported_at: '2025-08-18T13:22:46+00:00'
name: Foundry
author: eggs@goover.dev
uuid: d7fe62fe-16c8-4014-aaf5-a91a9978dff5
description: |-
  Build a factory optimized to perfection or an artistic masterpiece in an infinite voxel world. Mine
  and harvest resources, automate your ever-growing production lines and manage complex systems while
  researching your way to mechanical mastery in FOUNDRY.
tags: {  }
features:
  - steam_disk_space
docker_images:
  'ghcr.io/goover/wine:staging': 'ghcr.io/goover/wine:staging'
file_denylist: {  }
startup: 'wine ./FoundryDedicatedServer.exe -log'
config:
  files:
    App.cfg:
      parser: properties
      find:
        server_name: '{{server.environment.SERVER_NAME}}'
        server_password: '{{server.environment.SRV_PW}}'
        server_world_name: '{{server.environment.WORLD_NAME}}'
        server_max_players: '{{server.environment.MAX_PLAYERS}}'
        server_port: '{{server.allocations.default.port}}'
        server_query_port: '{{server.environment.QUERY_PORT}}'
        pause_server_when_empty: '{{server.environment.PAUSE_SERVER}}'
        autosave_interval: '{{server.environment.AUTOSAVE_INTERVAL}}'
        server_is_public: '{{server.environment.PUBLIC_SERVER}}'
        server_persistent_data_override_folder: '{{server.environment.SAVE_PATH}}'
        map_seed: '{{server.environment.MAP_SEED}}'
        max_transfer_rate: '{{server.environment.MAX_TRANSFER}}'
  startup:
    done: 'Dedicated server is now running!'
  logs: {  }
  stop: ^C
scripts:
  installation:
    script: |
      #!/bin/bash
      # THIS EGG IS LICENSED UNDER AGPLv3

      set -euo pipefail

      # --- Colors ---
      RED=$(tput setaf 1)
      GREEN=$(tput setaf 2)
      YELLOW=$(tput setaf 3)
      BLUE=$(tput setaf 4)
      NC=$(tput sgr0)

      # --- Logging functions ---
      log_info()    { echo "${BLUE}[INFO]${NC} $*"; }
      log_warn()    { echo "${YELLOW}[WARN]${NC} $*"; }
      log_error()   { echo "${RED}[ERROR]${NC} $*" >&2; }
      log_success() { echo "${GREEN}[ OK ]${NC} $*"; }

      # --- Helper for running commands safely ---
      run_or_fail() {
          local desc="$1"; shift
          if "$@"; then
              log_success "$desc"
          else
              log_error "$desc failed!"
              exit 1
          fi
      }

      # --- Header ---
      print_header() {
          clear
          echo "${BLUE}----------------------------------------------------------------${NC}"
          echo "${YELLOW}${GAMENAME} Installation Script${NC}"
          echo "${YELLOW}Egg by gOOvER (https://discord.goover.dev) | License: AGPLv3${NC}"
          echo "${YELLOW}This EGG is Licenced under AGPLv3${NC}"
          echo "${BLUE}----------------------------------------------------------------${NC}"
      }

      # --- Config ---
      GAMENAME="Foundry"
      # --- Set to 1, if you want to use DepotDownloader insteed steamcmd
      DEPOTDOWNLOADER=0

      mkdir -p /mnt/server
      chown -R root:root /mnt
      export HOME=/mnt/server

      STEAM_USER="${STEAM_USER:-anonymous}"
      STEAM_PASS="${STEAM_PASS:-}"
      STEAM_AUTH="${STEAM_AUTH:-}"

      print_header

      if [[ -z "${STEAM_APPID:-}" ]]; then
          log_error "STEAM_APPID is not set!"
          exit 1
      fi

      if [[ "$STEAM_USER" == "anonymous" ]]; then
          log_info "Using anonymous Steam login"
      fi

      # --- DepotDownloader installation ---
      if [[ "$DEPOTDOWNLOADER" == "1" ]]; then
          log_info "Installing game using DepotDownloader..."
          cd "$HOME"

          LATEST_RELEASE=$(curl -s https://api.github.com/repos/SteamRE/DepotDownloader/releases/latest \
              | grep browser_download_url \
              | cut -d'"' -f4 \
              | grep linux-x64.zip)

          run_or_fail "Download DepotDownloader" curl -sLOJ "$LATEST_RELEASE"
          run_or_fail "Extract DepotDownloader" unzip -o DepotDownloader-linux-x64.zip -d /mnt/server
          chmod +x /mnt/server/DepotDownloader

          DOWNLOADER_ARGS=(-dir "/mnt/server" -app "$STEAM_APPID" -validate)

          [[ "$STEAM_USER" != "anonymous" ]] && DOWNLOADER_ARGS+=(-username "$STEAM_USER" -password "$STEAM_PASS" -remember-password)
          [[ "${WINDOWS_INSTALL:-0}" == "1" ]] && DOWNLOADER_ARGS+=(-os windows)
          [[ -n "${STEAM_BETAID:-}" ]] && DOWNLOADER_ARGS+=(-beta "$STEAM_BETAID")
          [[ -n "${STEAM_BETAPASS:-}" ]] && DOWNLOADER_ARGS+=(-betapassword "$STEAM_BETAPASS")

          run_or_fail "Download game files" ./DepotDownloader "${DOWNLOADER_ARGS[@]}"

          mkdir -p /mnt/server/.steam/sdk64
          run_or_fail "Download Steam SDK" ./DepotDownloader -dir "/mnt/server/.steam/sdk64" -app 1007

      # --- SteamCMD installation ---
      else
          log_info "Installing game using SteamCMD..."
          mkdir -p /mnt/server/steamcmd /mnt/server/steamapps
          cd /mnt/server/steamcmd

          run_or_fail "Download SteamCMD" curl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
          run_or_fail "Extract SteamCMD" tar -xzf steamcmd.tar.gz

          STEAMCMD_ARGS=(+force_install_dir "/mnt/server" +login "$STEAM_USER" "$STEAM_PASS" "$STEAM_AUTH" +app_update "$STEAM_APPID" validate +quit)

          [[ "${WINDOWS_INSTALL:-0}" == "1" ]] && STEAMCMD_ARGS=(+@sSteamCmdForcePlatformType windows "${STEAMCMD_ARGS[@]}")
          [[ "${STEAM_SDK:-0}" == "1" ]] && STEAMCMD_ARGS=(+app_update 1007 "${STEAMCMD_ARGS[@]}")
          [[ -n "${STEAM_BETAID:-}" ]] && STEAMCMD_ARGS+=(-beta "$STEAM_BETAID")
          [[ -n "${STEAM_BETAPASS:-}" ]] && STEAMCMD_ARGS+=(-betapassword "$STEAM_BETAPASS")
          [[ -n "${INSTALL_FLAGS:-}" ]] && STEAMCMD_ARGS+=($INSTALL_FLAGS)

          run_or_fail "Install game via SteamCMD" ./steamcmd.sh "${STEAMCMD_ARGS[@]}"

          mkdir -p /mnt/server/.steam/sdk32 /mnt/server/.steam/sdk64
          cp -v linux32/steamclient.so ../.steam/sdk32/
          cp -v linux64/steamclient.so ../.steam/sdk64/
      fi

      echo "${BLUE}-------------------------------------------------${NC}"
      log_success "Installation completed successfully"
      echo "${BLUE}-------------------------------------------------${NC}"
    container: 'ghcr.io/goover/installers:debian'
    entrypoint: bash
variables:
  -
    name: Savepath
    description: ''
    env_variable: SAVE_PATH
    default_value: /home/container/serverfiles
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
    sort: 14
  -
    name: WINDOWS_INSTALL
    description: ''
    env_variable: WINDOWS_INSTALL
    default_value: 1
    user_viewable: false
    user_editable: false
    rules:
      - required
      - 'in:1'
    sort: 10
  -
    name: '[SERVER] Autosave Interval'
    description: 'Sets the autosave frequency in seconds.'
    env_variable: AUTOSAVE_INTERVAL
    default_value: 300
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
    sort: 5
  -
    name: '[SERVER] Map Seed'
    description: 'Sets the map seed used to generate the world.'
    env_variable: MAP_SEED
    default_value: 42938743982
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
    sort: 8
  -
    name: '[SERVER] Max Transfer Rate'
    description: ''
    env_variable: MAX_TRANSFER
    default_value: 1024
    user_viewable: true
    user_editable: true
    rules:
      - required
      - integer
      - 'between:1024,8192'
    sort: 15
  -
    name: '[SERVER] Pause Server When Empty'
    description: 'Will the server pause when nobody is connected.'
    env_variable: PAUSE_SERVER
    default_value: true
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - 'in:true,false'
    sort: 4
  -
    name: '[SERVER] Server Max Players'
    description: 'This sets the max amount of players on a server.'
    env_variable: MAX_PLAYERS
    default_value: 32
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
    sort: 9
  -
    name: '[SERVER] Server Name'
    description: 'This is the name of the server listed in the Steam server browser.'
    env_variable: SERVER_NAME
    default_value: ''
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - 'max:40'
    sort: 1
  -
    name: '[SERVER] Server Password'
    description: 'Sets the server password.'
    env_variable: SRV_PW
    default_value: ''
    user_viewable: true
    user_editable: true
    rules:
      - nullable
      - string
      - 'max:20'
    sort: 3
  -
    name: '[SERVER] Server Public'
    description: 'Sets whether the server is listed on the Steam server browser.'
    env_variable: PUBLIC_SERVER
    default_value: true
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - 'in:true,false'
    sort: 6
  -
    name: '[SERVER] Server World Name'
    description: 'Sets the server world name. This is the folder where the save files will be stored.'
    env_variable: WORLD_NAME
    default_value: ServerWorld
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - 'max:20'
    sort: 2
  -
    name: '[SERVER] Steam Query Port'
    description: |-
      Sets the network port used by the Steam server browser to query information about the game. This is
      only used if the server is set to public.
    env_variable: QUERY_PORT
    default_value: ''
    user_viewable: true
    user_editable: true
    rules:
      - required
      - integer
      - 'between:1024,65536'
    sort: 7
  -
    name: '[STEAM] Steam App ID'
    description: 'Steam App ID'
    env_variable: STEAM_APPID
    default_value: 2915550
    user_viewable: false
    user_editable: false
    rules:
      - required
      - string
      - 'in:2915550'
    sort: 11
  -
    name: '[WINE] WINEDEBUG'
    description: ''
    env_variable: WINEDEBUG
    default_value: '-all'
    user_viewable: false
    user_editable: false
    rules:
      - required
      - string
    sort: 13
  -
    name: '[WINE] WINETRICKS_RUN'
    description: ''
    env_variable: WINETRICKS_RUN
    default_value: mono
    user_viewable: false
    user_editable: false
    rules:
      - required
      - string
    sort: 12
